# ë…¼ë¦¬ì  ì‚­ì œ (Soft Delete) ê¸°ëŠ¥ êµ¬í˜„

## ğŸ“… ì‘ì—… ì¼ì‹œ
**2025-11-26**

---

## ğŸ¯ ì‘ì—… ë°°ê²½

ê¸°ì¡´ ë¬¼ë¦¬ì  ì‚­ì œ(Hard Delete) ë°©ì‹ì€ ë§¤ë§¤ ê¸°ë¡ì„ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì˜êµ¬ì ìœ¼ë¡œ ì œê±°í•˜ì—¬ ë³µêµ¬ê°€ ë¶ˆê°€ëŠ¥í–ˆìŠµë‹ˆë‹¤. ì‹¤ìˆ˜ë¡œ ì‚­ì œí•œ ê²½ìš°ë‚˜ ë‚˜ì¤‘ì— ê³¼ê±° ë§¤ë§¤ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ì‹¶ì„ ë•Œ ë¬¸ì œê°€ ë  ìˆ˜ ìˆì–´, ë…¼ë¦¬ì  ì‚­ì œ(Soft Delete) ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•˜ê¸°ë¡œ ê²°ì •í–ˆìŠµë‹ˆë‹¤.

---

## ğŸ’¡ ê¸°ìˆ ì  ê²°ì • ì‚¬í•­

### 1. ë¬¼ë¦¬ì  ì‚­ì œ vs ë…¼ë¦¬ì  ì‚­ì œ

**ì„ íƒ**: ë…¼ë¦¬ì  ì‚­ì œ (Soft Delete)

**ì´ìœ **:
- âœ… **ë³µêµ¬ ê°€ëŠ¥**: ì‹¤ìˆ˜ë¡œ ì‚­ì œí•´ë„ ë°ì´í„° ë³µì› ê°€ëŠ¥
- âœ… **ë°ì´í„° ë³´ì¡´**: í†µê³„ ë° ë¶„ì„ì— ëª¨ë“  ë°ì´í„° í™œìš© ê°€ëŠ¥
- âœ… **ê°ì‚¬ ì¶”ì **: ì–¸ì œ ì‚­ì œë˜ì—ˆëŠ”ì§€ ê¸°ë¡ ë³´ì¡´
- âœ… **íšŒê³  ê°€ëŠ¥**: ê³¼ê±° ë§¤ë§¤ íŒ¨í„´ ë¶„ì„ ê°€ëŠ¥

### 2. êµ¬í˜„ ë°©ì‹

**deletedAt ì»¬ëŸ¼ ì¶”ê°€**:
- `null`: í™œì„± ë§¤ë§¤
- `LocalDateTime`: ì‚­ì œëœ ì‹œê°„

---

## ğŸ›  êµ¬í˜„ ë‚´ìš©

### 1. ë°±ì—”ë“œ ìˆ˜ì • (3ê°œ íŒŒì¼)

#### ğŸ“„ [Trade.kt](file:///c:/workdir/space-cap/trading-journal/backend/src/main/kotlin/com/spacecap/tradingjournal/domain/Trade.kt)
**ë³€ê²½ ì‚¬í•­**:
- `deletedAt` í•„ë“œ ì¶”ê°€ (LocalDateTime?, nullable)

```kotlin
@Entity
@Table(name = "trades")
data class Trade(
    ...
    var exitDate: LocalDateTime? = null,
    var deletedAt: LocalDateTime? = null  // ì¶”ê°€
)
```

#### ğŸ“„ [TradeRepository.kt](file:///c:/workdir/space-cap/trading-journal/backend/src/main/kotlin/com/spacecap/tradingjournal/repository/TradeRepository.kt)
**ë³€ê²½ ì‚¬í•­**:
- í™œì„± ë§¤ë§¤ë§Œ ì¡°íšŒí•˜ëŠ” ë©”ì„œë“œ ì¶”ê°€

```kotlin
interface TradeRepository : JpaRepository<Trade, Long> {
    fun findByDeletedAtIsNull(): List<Trade>  // ì¶”ê°€
}
```

#### ğŸ“„ [TradeService.kt](file:///c:/workdir/space-cap/trading-journal/backend/src/main/kotlin/com/spacecap/tradingjournal/service/TradeService.kt)
**ë³€ê²½ ì‚¬í•­**:
1. `getAllTrades()`: í™œì„± ë§¤ë§¤ë§Œ ì¡°íšŒ
2. `deleteTrade()`: ë¬¼ë¦¬ì  ì‚­ì œ â†’ ë…¼ë¦¬ì  ì‚­ì œ

```kotlin
// Before
fun getAllTrades(): List<Trade> = tradeRepository.findAll()

fun deleteTrade(id: Long) {
    tradeRepository.deleteById(id)  // ì˜êµ¬ ì‚­ì œ
}

// After
fun getAllTrades(): List<Trade> = tradeRepository.findByDeletedAtIsNull()

fun deleteTrade(id: Long) {
    val trade = tradeRepository.findById(id)
        .orElseThrow { IllegalArgumentException("Trade not found with id: $id") }
    trade.deletedAt = LocalDateTime.now()  // ì‚­ì œ ì‹œê°„ ì„¤ì •
    tradeRepository.save(trade)
}
```

---

## ğŸ“Š ë³€ê²½ í†µê³„

### íŒŒì¼ ë³€ê²½
- **ìˆ˜ì •**: 3ê°œ (Trade.kt, TradeRepository.kt, TradeService.kt)
- **ì¶”ê°€ ì½”ë“œ**: ì•½ 10ì¤„

### ë°ì´í„°ë² ì´ìŠ¤
- **ìƒˆ ì»¬ëŸ¼**: `deleted_at` (DATETIME, nullable)
- **ì¸ë±ìŠ¤**: í–¥í›„ ì¶”ê°€ ê³ ë ¤ (`idx_trades_deleted_at`)

---

## ğŸ”„ ë™ì‘ ë°©ì‹

### Before (ë¬¼ë¦¬ì  ì‚­ì œ)
```sql
DELETE FROM trades WHERE id = 1;
â†’ ë°ì´í„° ì˜êµ¬ ì‚­ì œ, ë³µêµ¬ ë¶ˆê°€ëŠ¥
```

### After (ë…¼ë¦¬ì  ì‚­ì œ)
```sql
UPDATE trades SET deleted_at = '2025-11-26 10:45:00' WHERE id = 1;
â†’ ë°ì´í„° ë³´ì¡´, ì‚­ì œ í”Œë˜ê·¸ë§Œ ì„¤ì •
```

### ì¡°íšŒ í•„í„°ë§
```sql
-- í™œì„± ë§¤ë§¤ë§Œ ì¡°íšŒ
SELECT * FROM trades WHERE deleted_at IS NULL;

-- ì‚­ì œëœ ë§¤ë§¤ ì¡°íšŒ (í–¥í›„ íœ´ì§€í†µ ê¸°ëŠ¥)
SELECT * FROM trades WHERE deleted_at IS NOT NULL;
```

---

## âœ… í…ŒìŠ¤íŠ¸ ê²°ê³¼

### ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
1. âœ… ë§¤ë§¤ ì‚­ì œ ì‹œ ëª©ë¡ì—ì„œ ì‚¬ë¼ì§€ëŠ”ì§€ í™•ì¸
2. âœ… ì‚­ì œ í›„ ë°ì´í„°ë² ì´ìŠ¤ì— ë°ì´í„°ê°€ ë‚¨ì•„ìˆëŠ”ì§€ í™•ì¸
3. âœ… `deleted_at` ì»¬ëŸ¼ì— ì‹œê°„ì´ ì„¤ì •ë˜ëŠ”ì§€ í™•ì¸
4. âœ… í™œì„± ë§¤ë§¤ ì¡°íšŒ ì‹œ ì‚­ì œëœ ë§¤ë§¤ê°€ ì œì™¸ë˜ëŠ”ì§€ í™•ì¸

### H2 Console í™•ì¸
```sql
-- ëª¨ë“  ë§¤ë§¤ ì¡°íšŒ (ì‚­ì œëœ ê²ƒ í¬í•¨)
SELECT id, symbol, entry_price, deleted_at FROM trades;

-- ê²°ê³¼ ì˜ˆì‹œ:
-- id | symbol | entry_price | deleted_at
-- 1  | AAPL   | 150.00      | 2025-11-26 10:45:00  (ì‚­ì œë¨)
-- 2  | TSLA   | 200.00      | NULL                 (í™œì„±)
```

---

## ğŸ“ íšŒê³ 

### ì˜í•œ ì 
1. âœ… **ì•ˆì „í•œ ì‚­ì œ**: ì‹¤ìˆ˜ë¡œ ì‚­ì œí•´ë„ ë³µêµ¬ ê°€ëŠ¥
2. âœ… **ìµœì†Œ ë³€ê²½**: 3ê°œ íŒŒì¼ë§Œ ìˆ˜ì •í•˜ì—¬ êµ¬í˜„ ì™„ë£Œ
3. âœ… **í•˜ìœ„ í˜¸í™˜ì„±**: ê¸°ì¡´ API ì—”ë“œí¬ì¸íŠ¸ ë³€ê²½ ì—†ìŒ
4. âœ… **JPA í™œìš©**: Spring Data JPAì˜ ë©”ì„œë“œ ë„¤ì´ë° ê·œì¹™ í™œìš©

### ê°œì„ í•  ì 
1. âš ï¸ **ì¸ë±ìŠ¤ ë¶€ì¬**: `deleted_at` ì»¬ëŸ¼ì— ì¸ë±ìŠ¤ ì¶”ê°€ ê³ ë ¤
2. âš ï¸ **íœ´ì§€í†µ ë¯¸êµ¬í˜„**: ì‚­ì œëœ ë§¤ë§¤ë¥¼ ë³¼ ìˆ˜ ìˆëŠ” UI ì—†ìŒ
3. âš ï¸ **ë³µì› ê¸°ëŠ¥ ë¯¸êµ¬í˜„**: ì‚­ì œëœ ë§¤ë§¤ ë³µì› ê¸°ëŠ¥ ì—†ìŒ
4. âš ï¸ **ìë™ ì •ë¦¬ ë¯¸êµ¬í˜„**: ì˜¤ë˜ëœ ì‚­ì œ ë°ì´í„° ìë™ ì •ë¦¬ ì—†ìŒ

### ë°°ìš´ ì 
1. ğŸ’¡ **ë…¼ë¦¬ì  ì‚­ì œ íŒ¨í„´**: Soft Delete êµ¬í˜„ ë°©ë²•
2. ğŸ’¡ **JPA ì¿¼ë¦¬ ë©”ì„œë“œ**: `findByDeletedAtIsNull()` ë„¤ì´ë° ê·œì¹™
3. ğŸ’¡ **ë°ì´í„° ë³´ì¡´ì˜ ì¤‘ìš”ì„±**: ë§¤ë§¤ ë°ì´í„°ëŠ” ë¶„ì„ì— ì¤‘ìš”í•œ ìì‚°

---

## ğŸš€ í–¥í›„ ì‘ì—…

### ë‹¨ê¸° ê°œì„  ì‚¬í•­
- [ ] `deleted_at` ì»¬ëŸ¼ì— ì¸ë±ìŠ¤ ì¶”ê°€
- [ ] ì‚­ì œ í™•ì¸ ë©”ì‹œì§€ ê°œì„  ("ë³µêµ¬ ê°€ëŠ¥í•©ë‹ˆë‹¤" ì•ˆë‚´)

### ì¤‘ê¸° í™•ì¥
- [ ] íœ´ì§€í†µ UI êµ¬í˜„
  - ì‚­ì œëœ ë§¤ë§¤ ëª©ë¡ ì¡°íšŒ
  - ë³µì› ë²„íŠ¼
  - ì˜êµ¬ ì‚­ì œ ë²„íŠ¼
- [ ] ë³µì› API êµ¬í˜„
  ```kotlin
  fun restoreTrade(id: Long) {
      val trade = tradeRepository.findById(id).orElseThrow()
      trade.deletedAt = null
      tradeRepository.save(trade)
  }
  ```

### ì¥ê¸° í™•ì¥
- [ ] ìë™ ì •ë¦¬ ìŠ¤ì¼€ì¤„ëŸ¬
  - 30ì¼ ì´ìƒ ì‚­ì œëœ ë§¤ë§¤ ìë™ ì˜êµ¬ ì‚­ì œ
  - ì˜êµ¬ ì‚­ì œ ì „ ì•Œë¦¼
- [ ] ê°ì‚¬ ë¡œê·¸
  - ëˆ„ê°€ ì–¸ì œ ì‚­ì œí–ˆëŠ”ì§€ ê¸°ë¡
  - ë³µì› ì´ë ¥ ì¶”ì 

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [Soft Delete Pattern](https://www.baeldung.com/spring-jpa-soft-delete)
- [Spring Data JPA Query Methods](https://docs.spring.io/spring-data/jpa/docs/current/reference/html/#jpa.query-methods)

---

**ì‘ì„±ì**: Antigravity AI  
**ì‘ì—… ì™„ë£Œì¼**: 2025-11-26  
**ì†Œìš” ì‹œê°„**: ì•½ 30ë¶„  
**ë‚œì´ë„**: â­â­â­ (ì¤‘)
